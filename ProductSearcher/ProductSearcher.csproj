<Project Sdk="Microsoft.NET.Sdk.Web">

    <PropertyGroup>
        <TargetFramework>net5.0</TargetFramework>
        <TypeScriptCompileBlocked>true</TypeScriptCompileBlocked>
        <TypeScriptToolsVersion>Latest</TypeScriptToolsVersion>
        <IsPackable>false</IsPackable>
        <SpaRoot>ClientApp\</SpaRoot>
        <DefaultItemExcludes>$(DefaultItemExcludes);$(SpaRoot)node_modules\**</DefaultItemExcludes>

        <!-- Set this to true if you enable server-side prerendering -->
        <BuildServerSideRenderer>false</BuildServerSideRenderer>
        <RootNamespace>ProductSearcher</RootNamespace>
    </PropertyGroup>

    <ItemGroup>
        <PackageReference Include="Microsoft.AspNetCore.SpaServices.Extensions" Version="5.0.2"/>
        <PackageReference Include="Newtonsoft.Json" Version="13.0.1"/>
    </ItemGroup>

    <Target Name="DebugLocal" BeforeTargets="Build" Condition=" '$(Configuration)' == 'Debug'">
        <ItemGroup>
            <!-- Don't publish the SPA source files, but do show them in the project files list -->
            <Content Remove="$(SpaRoot)**"/>
            <None Remove="$(SpaRoot)**"/>
            <None Include="$(SpaRoot)**" Exclude="$(SpaRoot)node_modules\**"/>
            <None Update="Finders\placeholder.txt">
                <CopyToOutputDirectory>Always</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\AtbIntegration\AtbIntegrator.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\AtbIntegration\ProductFinder.Core.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Varus\VarusIntegrator.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Novus\NovusIntegrator.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Update="wwwroot\favicon.ico">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\main.4de6cc4dec00f60f.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\polyfills.f514913fa3bcd22d.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\runtime.e030c5a7e493f3a9.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\styles.ef46db3751d8e999.css">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Remove="wwwroot\runtime.cb2efa9c5b618db3.js"/>
            <Content Remove="wwwroot\polyfills.4a03ad532fe51edd.js"/>
            <Content Remove="wwwroot\main.9bbd3f05091f5af8.js"/>
            <Content Remove="wwwroot\141.b56e9b2cf4efe8c8.js"/>
            <Content Update="wwwroot\141.0216be1f58efadac.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\3rdpartylicenses.txt">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\index.html">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\main.cc176866408502cb.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\polyfills.5796acb65b66bb59.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\runtime.4702e330a6f9d788.js">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <Content Update="wwwroot\styles.3f67fd504fb0fdff.css">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </Content>
            <None Update="ShopIntegration\Novus\Newtonsoft.Json.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Novus\NovusIntegration.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Novus\NovusIntegration.pdb">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Atb\AtbIntegration.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Atb\AtbIntegration.pdb">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Atb\AtbIntegration.deps.json"/>
            <None Include="ShopIntegration\Atb\AtbIntegration.deps.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Atb\AtbIntegration.runtimeconfig.json"/>
            <None Include="ShopIntegration\Atb\AtbIntegration.runtimeconfig.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Atb\AtbIntegration.runtimeconfig.dev.json"/>
            <None Include="ShopIntegration\Atb\AtbIntegration.runtimeconfig.dev.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Atb\Newtonsoft.Json.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Novus\NovusIntegration.deps.json"/>
            <None Include="ShopIntegration\Novus\NovusIntegration.deps.json"/>
            <Content Remove="ShopIntegration\Novus\NovusIntegration.runtimeconfig.json"/>
            <None Include="ShopIntegration\Novus\NovusIntegration.runtimeconfig.json"/>
            <Content Remove="ShopIntegration\Novus\NovusIntegration.runtimeconfig.dev.json"/>
            <None Include="ShopIntegration\Novus\NovusIntegration.runtimeconfig.dev.json"/>
            <None Update="ShopIntegration\Varus\Newtonsoft.Json.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Varus\VarusIntegration.dll">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <None Update="ShopIntegration\Varus\VarusIntegration.pdb">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Varus\VarusIntegration.deps.json"/>
            <None Include="ShopIntegration\Varus\VarusIntegration.deps.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Varus\VarusIntegration.runtimeconfig.json"/>
            <None Include="ShopIntegration\Varus\VarusIntegration.runtimeconfig.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
            <Content Remove="ShopIntegration\Varus\VarusIntegration.runtimeconfig.dev.json"/>
            <None Include="ShopIntegration\Varus\VarusIntegration.runtimeconfig.dev.json">
                <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
            </None>
        </ItemGroup>
    </Target>

    <ItemGroup>
        <_ContentIncludedByDefault Remove="Pages\Error.cshtml"/>
        <_ContentIncludedByDefault Remove="Pages\_ViewImports.cshtml"/>
        <_ContentIncludedByDefault Remove="ClientApp\angular.json"/>
        <_ContentIncludedByDefault Remove="ClientApp\package-lock.json"/>
        <_ContentIncludedByDefault Remove="ClientApp\package.json"/>
        <_ContentIncludedByDefault Remove="ClientApp\tsconfig.app.json"/>
        <_ContentIncludedByDefault Remove="ClientApp\tsconfig.json"/>
        <_ContentIncludedByDefault Remove="ClientApp\tsconfig.spec.json"/>
    </ItemGroup>

    <ItemGroup>
        <Reference Include="ProductFinder.Core, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null">
            <HintPath>..\ProductFinder.Core\ProductFinder.Core.dll</HintPath>
        </Reference>
    </ItemGroup>

    <Target Name="DebugEnsureNodeEnv" BeforeTargets="Build" Condition=" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') ">
        <!-- Ensure Node.js is installed -->
        <Exec Command="node --version" ContinueOnError="true">
            <Output TaskParameter="ExitCode" PropertyName="ErrorCode"/>
        </Exec>
        <Error Condition="'$(ErrorCode)' != '0'" Text="Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."/>
        <Message Importance="high" Text="Restoring dependencies using 'npm'. This may take several minutes..."/>
        <Exec WorkingDirectory="$(SpaRoot)" Command="npm install"/>
    </Target>

    <Target Name="PublishRunWebpack" AfterTargets="ComputeFilesToPublish">
        <!-- As part of publishing, ensure the JS resources are freshly built in production mode -->
        <Exec WorkingDirectory="$(SpaRoot)" Command="npm install" />
        <Exec WorkingDirectory="$(SpaRoot)" Command="npm run build -- --prod" />
        <Exec WorkingDirectory="$(SpaRoot)" Command="npm run build:ssr -- --prod" Condition=" '$(BuildServerSideRenderer)' == 'true' " />

        <!-- Include the newly-built files in the publish output -->
        <ItemGroup>
            <DistFiles Include="$(SpaRoot)dist\**; $(SpaRoot)dist-server\**" />
            <DistFiles Include="$(SpaRoot)node_modules\**" Condition="'$(BuildServerSideRenderer)' == 'true'" />
            <ResolvedFileToPublish Include="@(DistFiles->'%(FullPath)')" Exclude="@(ResolvedFileToPublish)">
                <RelativePath>%(DistFiles.Identity)</RelativePath>
                <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
                <ExcludeFromSingleFile>true</ExcludeFromSingleFile>
            </ResolvedFileToPublish>
        </ItemGroup>
    </Target>

</Project>
